{% load static %}
{% load widget_tweaks %}

<!-- Individual form field component -->
<div class="form-group {% if field.field.required %}required{% endif %} {% if field.errors %}is-invalid{% endif %}"
     data-field-name="{{ field.name }}"
     data-field-type="{{ field.field.__class__.__name__ }}">
    
    <!-- Field Label -->
    {% if field.label %}
        <label for="{{ field.id_for_label }}" 
               class="form-label">
            {{ field.label }}
            {% if field.field.required %}
                <span class="required-indicator" aria-label="required">*</span>
            {% endif %}
            {% if field.help_text %}
                <button type="button" 
                        class="help-toggle"
                        aria-label="Help for {{ field.label }}"
                        data-toggle="tooltip"
                        title="{{ field.help_text }}">
                    <i class="fas fa-question-circle" aria-hidden="true"></i>
                </button>
            {% endif %}
        </label>
    {% endif %}
    
    <!-- Field Input -->
    <div class="form-input-wrapper">
        {% if field.field.__class__.__name__ == 'CharField' and field.field.widget.__class__.__name__ == 'Textarea' %}
            <!-- Textarea -->
            {{ field|add_class:"form-control"|attr:"placeholder:Enter your text here" }}
            
        {% elif field.field.__class__.__name__ == 'ImageField' or field.field.__class__.__name__ == 'FileField' %}
            <!-- File/Image Upload -->
            <div class="file-upload-wrapper">
                <input type="file" 
                       name="{{ field.name }}" 
                       id="{{ field.id_for_label }}"
                       class="file-input"
                       {% if field.field.required %}required{% endif %}
                       {% if field.field.__class__.__name__ == 'ImageField' %}accept="image/*"{% endif %}>
                       
                <label for="{{ field.id_for_label }}" class="file-label">
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    <span class="file-label-text">
                        {% if field.field.__class__.__name__ == 'ImageField' %}
                            Choose image or drag here
                        {% else %}
                            Choose file or drag here
                        {% endif %}
                    </span>
                </label>
                
                <div class="file-preview" style="display: none;">
                    <div class="file-info">
                        <i class="file-icon fas fa-file" aria-hidden="true"></i>
                        <span class="file-name"></span>
                        <span class="file-size"></span>
                        <button type="button" class="file-remove" aria-label="Remove file">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>
            
        {% elif field.field.__class__.__name__ == 'ChoiceField' %}
            <!-- Select Field -->
            {{ field|add_class:"form-control" }}
            
        {% elif field.field.__class__.__name__ == 'BooleanField' %}
            <!-- Checkbox -->
            <div class="form-check">
                {{ field|add_class:"form-check-input" }}
                <label for="{{ field.id_for_label }}" class="form-check-label">
                    {{ field.label }}
                    {% if field.field.required %}
                        <span class="required-indicator">*</span>
                    {% endif %}
                </label>
            </div>
            
        {% elif field.field.__class__.__name__ == 'DateField' %}
            <!-- Date Field -->
            <div class="date-input-wrapper">
                {{ field|add_class:"form-control date-input"|attr:"placeholder:YYYY-MM-DD" }}
                <button type="button" class="date-picker-toggle" aria-label="Open date picker">
                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                </button>
            </div>
            
        {% elif field.field.__class__.__name__ == 'EmailField' %}
            <!-- Email Field -->
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        <i class="fas fa-envelope" aria-hidden="true"></i>
                    </span>
                </div>
                {{ field|add_class:"form-control"|attr:"placeholder:Enter your email address" }}
            </div>
            
        {% elif field.field.__class__.__name__ == 'URLField' %}
            <!-- URL Field -->
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        <i class="fas fa-link" aria-hidden="true"></i>
                    </span>
                </div>
                {{ field|add_class:"form-control"|attr:"placeholder:https://example.com" }}
            </div>
            
        {% elif 'phone' in field.name|lower %}
            <!-- Phone Field -->
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        <i class="fas fa-phone" aria-hidden="true"></i>
                    </span>
                </div>
                {{ field|add_class:"form-control phone-input"|attr:"placeholder:+201234567890" }}
            </div>
            
        {% elif 'password' in field.name|lower %}
            <!-- Password Field -->
            <div class="password-input-wrapper">
                {{ field|add_class:"form-control password-input"|attr:"placeholder:Enter your password" }}
                <button type="button" 
                        class="password-toggle" 
                        aria-label="Toggle password visibility"
                        data-toggle="password">
                    <i class="fas fa-eye" aria-hidden="true"></i>
                </button>
            </div>
            
        {% elif field.field.__class__.__name__ == 'DecimalField' or field.field.__class__.__name__ == 'FloatField' %}
            <!-- Decimal/Float Field -->
            <div class="input-group">
                {% if 'price' in field.name|lower or 'amount' in field.name|lower or 'goal' in field.name|lower %}
                    <div class="input-group-prepend">
                        <span class="input-group-text">EGP</span>
                    </div>
                {% endif %}
                {{ field|add_class:"form-control number-input" }}
            </div>
            
        {% else %}
            <!-- Default Text Input -->
            {{ field|add_class:"form-control" }}
        {% endif %}
        
        <!-- Field Suffix (for additional icons or buttons) -->
        {% if field.field.widget.attrs.suffix %}
            <div class="input-suffix">
                {{ field.field.widget.attrs.suffix|safe }}
            </div>
        {% endif %}
    </div>
    
    <!-- Help Text -->
    {% if field.help_text %}
        <div class="form-help" id="help-{{ field.id_for_label }}">
            <i class="fas fa-info-circle" aria-hidden="true"></i>
            {{ field.help_text }}
        </div>
    {% endif %}
    
    <!-- Field Errors -->
    {% if field.errors %}
        <div class="invalid-feedback" id="error-{{ field.id_for_label }}">
            {% for error in field.errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Character Counter (for text fields with max length) -->
    {% if field.field.max_length and field.field.__class__.__name__ == 'CharField' %}
        <div class="character-counter">
            <span class="current-count">0</span>/<span class="max-count">{{ field.field.max_length }}</span>
        </div>
    {% endif %}
</div>

<style>
/* Form Group Styles */
.form-group {
    margin-bottom: var(--spacing-lg);
    position: relative;
}

.form-group.required .form-label::after {
    content: '*';
    color: var(--danger-color);
    margin-left: var(--spacing-xs);
}

/* Label Styles */
.form-label {
    display: block;
    margin-bottom: var(--spacing-sm);
    font-weight: 600;
    color: var(--gray-700);
    font-size: var(--font-size-sm);
    line-height: 1.5;
}

.required-indicator {
    color: var(--danger-color);
    margin-left: var(--spacing-xs);
}

.help-toggle {
    background: none;
    border: none;
    color: var(--gray-500);
    cursor: pointer;
    margin-left: var(--spacing-xs);
    padding: 0;
    font-size: 0.875rem;
    transition: color 0.2s ease;
}

.help-toggle:hover {
    color: var(--primary-color);
}

/* Input Wrapper */
.form-input-wrapper {
    position: relative;
}

/* Input Group Styles */
.input-group {
    display: flex;
    width: 100%;
    position: relative;
}

.input-group-prepend,
.input-group-append {
    display: flex;
}

.input-group-text {
    display: flex;
    align-items: center;
    padding: var(--spacing-md);
    background-color: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-right: none;
    color: var(--gray-600);
    font-size: var(--font-size-sm);
    border-radius: var(--border-radius) 0 0 var(--border-radius);
}

.input-group .form-control {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

/* File Upload Styles */
.file-upload-wrapper {
    position: relative;
}

.file-input {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.file-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-xl);
    border: 2px dashed var(--gray-300);
    border-radius: var(--border-radius);
    background-color: var(--gray-50);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    min-height: 120px;
}

.file-label:hover {
    border-color: var(--primary-color);
    background-color: var(--primary-50);
}

.file-label i {
    font-size: 2rem;
    color: var(--gray-400);
    margin-bottom: var(--spacing-sm);
}

.file-label-text {
    color: var(--gray-600);
    font-size: var(--font-size-sm);
}

.file-preview {
    margin-top: var(--spacing-md);
    padding: var(--spacing-md);
    background-color: var(--gray-50);
    border-radius: var(--border-radius);
    border: 1px solid var(--gray-200);
}

.file-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.file-icon {
    color: var(--primary-color);
    font-size: 1.25rem;
}

.file-name {
    font-weight: 500;
    color: var(--gray-700);
    flex: 1;
}

.file-size {
    color: var(--gray-500);
    font-size: var(--font-size-sm);
}

.file-remove {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius);
    transition: background-color 0.2s ease;
}

.file-remove:hover {
    background-color: var(--danger-100);
}

/* Password Input Styles */
.password-input-wrapper {
    position: relative;
}

.password-toggle {
    position: absolute;
    right: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--gray-500);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius);
    transition: color 0.2s ease;
}

.password-toggle:hover {
    color: var(--gray-700);
}

/* Date Input Styles */
.date-input-wrapper {
    position: relative;
}

.date-picker-toggle {
    position: absolute;
    right: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--gray-500);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius);
    transition: color 0.2s ease;
}

.date-picker-toggle:hover {
    color: var(--primary-color);
}

/* Checkbox Styles */
.form-check {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    padding-left: 0;
}

.form-check-input {
    margin-top: 0.25rem;
}

.form-check-label {
    margin-bottom: 0;
    font-weight: normal;
}

/* Help Text */
.form-help {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-top: var(--spacing-sm);
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    line-height: 1.4;
}

/* Character Counter */
.character-counter {
    margin-top: var(--spacing-sm);
    font-size: var(--font-size-sm);
    color: var(--gray-500);
    text-align: right;
}

.character-counter .current-count {
    font-weight: 500;
}

.character-counter.warning .current-count {
    color: var(--warning-color);
}

.character-counter.danger .current-count {
    color: var(--danger-color);
}

/* Validation States */
.form-group.is-invalid .form-control {
    border-color: var(--danger-color);
    box-shadow: 0 0 0 0.125rem rgba(220, 53, 69, 0.25);
}

.form-group.is-invalid .input-group-text {
    border-color: var(--danger-color);
    background-color: rgba(220, 53, 69, 0.1);
}

.form-group.is-valid .form-control {
    border-color: var(--success-color);
    box-shadow: 0 0 0 0.125rem rgba(25, 135, 84, 0.25);
}

.form-group.is-valid .input-group-text {
    border-color: var(--success-color);
    background-color: rgba(25, 135, 84, 0.1);
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: var(--spacing-sm);
    font-size: var(--font-size-sm);
    color: var(--danger-color);
    line-height: 1.4;
}

.invalid-feedback div {
    margin-bottom: var(--spacing-xs);
}

.invalid-feedback div:last-child {
    margin-bottom: 0;
}

/* Input Suffix */
.input-suffix {
    position: absolute;
    right: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    pointer-events: none;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .form-group {
        margin-bottom: var(--spacing-md);
    }
    
    .file-label {
        padding: var(--spacing-lg);
        min-height: 100px;
    }
    
    .file-label i {
        font-size: 1.5rem;
    }
    
    .input-group {
        flex-direction: column;
    }
    
    .input-group-text {
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        border-right: 1px solid var(--gray-300);
        border-bottom: none;
    }
    
    .input-group .form-control {
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .form-label,
    .form-help {
        color: var(--gray-900);
    }
    
    .file-label {
        border-color: var(--gray-600);
    }
    
    .input-group-text {
        background-color: var(--gray-200);
        border-color: var(--gray-600);
    }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    .help-toggle,
    .password-toggle,
    .date-picker-toggle,
    .file-remove,
    .file-label {
        transition: none;
    }
}
</style>

<script>
(function() {
    'use strict';
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeFormFields();
    });
    
    function initializeFormFields() {
        // Initialize file upload fields
        initializeFileUploads();
        
        // Initialize password toggles
        initializePasswordToggles();
        
        // Initialize character counters
        initializeCharacterCounters();
        
        // Initialize phone number formatting
        initializePhoneFormatting();
        
        // Initialize date inputs
        initializeDateInputs();
    }
    
    function initializeFileUploads() {
        const fileInputs = document.querySelectorAll('.file-input');
        
        fileInputs.forEach(function(input) {
            const wrapper = input.closest('.file-upload-wrapper');
            const label = wrapper.querySelector('.file-label');
            const preview = wrapper.querySelector('.file-preview');
            const fileName = preview.querySelector('.file-name');
            const fileSize = preview.querySelector('.file-size');
            const removeBtn = preview.querySelector('.file-remove');
            
            // Handle file selection
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    
                    // Update icon based on file type
                    const icon = preview.querySelector('.file-icon');
                    if (file.type.startsWith('image/')) {
                        icon.className = 'file-icon fas fa-image';
                    } else if (file.type.includes('pdf')) {
                        icon.className = 'file-icon fas fa-file-pdf';
                    } else if (file.type.includes('word')) {
                        icon.className = 'file-icon fas fa-file-word';
                    } else {
                        icon.className = 'file-icon fas fa-file';
                    }
                    
                    label.style.display = 'none';
                    preview.style.display = 'block';
                } else {
                    label.style.display = 'flex';
                    preview.style.display = 'none';
                }
            });
            
            // Handle file removal
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    input.value = '';
                    label.style.display = 'flex';
                    preview.style.display = 'none';
                    
                    // Clear validation state
                    const formGroup = input.closest('.form-group');
                    if (formGroup) {
                        formGroup.classList.remove('is-invalid', 'is-valid');
                    }
                });
            }
            
            // Handle drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                label.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                label.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                label.addEventListener(eventName, unhighlight, false);
            });
            
            label.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                label.classList.add('dragover');
            }
            
            function unhighlight() {
                label.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            }
        });
    }
    
    function initializePasswordToggles() {
        const toggles = document.querySelectorAll('.password-toggle');
        
        toggles.forEach(function(toggle) {
            toggle.addEventListener('click', function() {
                const wrapper = toggle.closest('.password-input-wrapper');
                const input = wrapper.querySelector('.password-input');
                const icon = toggle.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                    toggle.setAttribute('aria-label', 'Hide password');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                    toggle.setAttribute('aria-label', 'Show password');
                }
            });
        });
    }
    
    function initializeCharacterCounters() {
        const textInputs = document.querySelectorAll('input[maxlength], textarea[maxlength]');
        
        textInputs.forEach(function(input) {
            const formGroup = input.closest('.form-group');
            const counter = formGroup.querySelector('.character-counter');
            
            if (counter) {
                const currentCount = counter.querySelector('.current-count');
                const maxLength = parseInt(input.getAttribute('maxlength'));
                
                function updateCounter() {
                    const length = input.value.length;
                    currentCount.textContent = length;
                    
                    // Update counter styling based on usage
                    counter.classList.remove('warning', 'danger');
                    
                    if (length > maxLength * 0.9) {
                        counter.classList.add('danger');
                    } else if (length > maxLength * 0.75) {
                        counter.classList.add('warning');
                    }
                }
                
                input.addEventListener('input', updateCounter);
                updateCounter(); // Initial update
            }
        });
    }
    
    function initializePhoneFormatting() {
        const phoneInputs = document.querySelectorAll('.phone-input');
        
        phoneInputs.forEach(function(input) {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                
                // Auto-format Egyptian phone numbers
                if (value.startsWith('20')) {
                    value = '+' + value;
                } else if (value.startsWith('01') && value.length === 11) {
                    value = '+2' + value;
                } else if (value.startsWith('1') && value.length === 10) {
                    value = '+20' + value;
                }
                
                e.target.value = value;
            });
        });
    }
    
    function initializeDateInputs() {
        const dateInputs = document.querySelectorAll('.date-input');
        
        dateInputs.forEach(function(input) {
            // Set type to date for better UX on modern browsers
            if (input.type !== 'date') {
                input.type = 'date';
            }
            
            // Handle date picker toggle
            const toggle = input.parentNode.querySelector('.date-picker-toggle');
            if (toggle) {
                toggle.addEventListener('click', function() {
                    input.showPicker && input.showPicker();
                });
            }
        });
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
})();
</script>