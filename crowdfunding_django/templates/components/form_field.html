<div class="form-group {% if field.field.required %}required{% endif %} {% if field.errors %}is-invalid{% endif %}">
  {% if field.label %}
  <label for="{{ field.id_for_label }}" class="form-label">
    {{ field.label }}
    {% if field.field.required %}<span class="required-indicator">*</span>{% endif %}
  </label>
  {% endif %}

  <div class="form-input-wrapper">
    {% if field.field.widget.input_type == 'file' %}
    <!-- File Upload Field -->
    <div class="file-upload-wrapper">
      {{ field }}
      <label for="{{ field.id_for_label }}" class="file-label">
        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
        <span class="file-label-text">Choose file or drag here</span>
      </label>
      <div class="file-preview" style="display: none;">
        <div class="file-info">
          <i class="file-icon fas fa-file" aria-hidden="true"></i>
          <span class="file-name"></span>
          <span class="file-size"></span>
          <button type="button" class="file-remove" aria-label="Remove file">
            <i class="fas fa-times" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>

    {% elif field.field.widget.input_type == 'checkbox' %}
    <!-- Checkbox Field -->
    <div class="form-check">
      {{ field }}
      <label for="{{ field.id_for_label }}" class="form-check-label">
        {{ field.label }}
        {% if field.field.required %}
        <span class="required-indicator">*</span>
        {% endif %}
      </label>
    </div>

    {% elif field.field.widget.input_type == 'date' %}
    <!-- Date Field -->
    <div class="date-input-wrapper">
      {{ field }}
      <button type="button" class="date-picker-toggle" aria-label="Open date picker">
        <i class="fas fa-calendar-alt" aria-hidden="true"></i>
      </button>
    </div>

    {% elif field.field.widget.input_type == 'email' %}
    <!-- Email Field -->
    <div class="input-group">
      <div class="input-group-prepend">
        <span class="input-group-text">
          <i class="fas fa-envelope" aria-hidden="true"></i>
        </span>
      </div>
      {{ field }}
    </div>

    {% elif field.field.widget.input_type == 'password' %}
    <!-- Password Field -->
    <div class="password-input-wrapper">
      {{ field }}
      <button type="button" class="password-toggle" aria-label="Toggle password visibility">
        <i class="fas fa-eye" aria-hidden="true"></i>
      </button>
    </div>

    {% elif field.field.widget.input_type == 'tel' or 'phone' in field.name %}
    <!-- Phone Field -->
    <div class="input-group">
      <div class="input-group-prepend">
        <span class="input-group-text">
          <i class="fas fa-phone" aria-hidden="true"></i>
        </span>
      </div>
      {{ field }}
    </div>

    {% else %}
    <!-- Default Field -->
    {{ field }}
    {% endif %}

    {% if field.help_text %}
    <div class="form-help" id="help-{{ field.id_for_label }}">
      <i class="fas fa-info-circle" aria-hidden="true"></i>
      {{ field.help_text }}
    </div>
    {% endif %}

    {% if field.errors %}
    <div class="invalid-feedback" id="error-{{ field.id_for_label }}">
      {% for error in field.errors %}
      <div>{{ error }}</div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<style>
.form-group {
  margin-bottom: 1.5rem;
  position: relative;
}

.form-group.required .form-label::after {
  content: '*';
  color: var(--danger-color);
  margin-left: 0.25rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--gray-700);
  font-weight: 500;
}

.form-input-wrapper {
  position: relative;
}

/* Input styles */
input[type="text"],
input[type="email"],
input[type="password"],
input[type="number"],
input[type="tel"],
input[type="url"],
input[type="date"],
textarea,
select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: var(--border-radius);
  background-color: var(--white);
  color: var(--gray-900);
  font-size: 1rem;
  transition: border-color 0.2s, box-shadow 0.2s;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--primary-color-light);
}

/* File upload styles */
.file-upload-wrapper {
  position: relative;
}

.file-input {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.file-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  border: 2px dashed var(--gray-300);
  border-radius: var(--border-radius);
  background-color: var(--gray-50);
  cursor: pointer;
  transition: all 0.3s ease;
}

.file-label:hover {
  border-color: var(--primary-color);
  background-color: var(--primary-color-light);
}

/* Input group styles */
.input-group {
  display: flex;
  align-items: stretch;
}

.input-group-prepend {
  display: flex;
}

.input-group-text {
  display: flex;
  align-items: center;
  padding: 0.75rem;
  background-color: var(--gray-100);
  border: 1px solid var(--gray-300);
  border-right: none;
  border-radius: var(--border-radius) 0 0 var(--border-radius);
  color: var(--gray-600);
}

.input-group .form-control {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}

/* Password field styles */
.password-input-wrapper {
  position: relative;
}

.password-toggle {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--gray-500);
  cursor: pointer;
  padding: 0.25rem;
}

/* Help text and error styles */
.form-help {
  margin-top: 0.5rem;
  color: var(--gray-600);
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.invalid-feedback {
  color: var(--danger-color);
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

.form-group.is-invalid input,
.form-group.is-invalid textarea,
.form-group.is-invalid select {
  border-color: var(--danger-color);
}

/* Checkbox styles */
.form-check {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  margin-top: 0.25rem;
}

.form-check-input {
  margin-top: 0.25rem;
}

.form-check-label {
  margin-bottom: 0;
  font-weight: normal;
}

/* Date picker styles */
.date-input-wrapper {
  position: relative;
}

.date-picker-toggle {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--gray-500);
  cursor: pointer;
  padding: 0.25rem;
}

/* Mobile styles */
@media (max-width: 768px) {
  .input-group {
    flex-direction: column;
  }

  .input-group-text {
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    border-right: 1px solid var(--gray-300);
    border-bottom: none;
  }

  .input-group .form-control {
    border-radius: 0 0 var(--border-radius) var(--border-radius);
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize file uploads
  const fileInputs = document.querySelectorAll('input[type="file"]');
  fileInputs.forEach(function(input) {
    const wrapper = input.closest('.file-upload-wrapper');
    if (wrapper) {
      const preview = wrapper.querySelector('.file-preview');
      const removeBtn = preview.querySelector('.file-remove');

      input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const fileName = preview.querySelector('.file-name');
          const fileSize = preview.querySelector('.file-size');
          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);
          preview.style.display = 'block';
        }
      });

      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          input.value = '';
          preview.style.display = 'none';
        });
      }
    }
  });

  // Initialize password toggles
  const passwordToggles = document.querySelectorAll('.password-toggle');
  passwordToggles.forEach(function(toggle) {
    toggle.addEventListener('click', function() {
      const input = toggle.parentNode.querySelector('input');
      const icon = toggle.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });
  });

  // Helper function to format file size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
});
</script>