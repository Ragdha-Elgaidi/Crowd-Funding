{% load static %}

<div class="card project-card" data-project-id="{{ project.id }}">
  <!-- Project image -->
  <div class="card-img-container">
    {% if project.image %}
    <img
      src="{{ project.image.url }}"
      alt="{{ project.title }}"
      class="card-img-top"
      loading="lazy"
    />
    {% else %}
    <div class="card-img-placeholder">
      <i class="fas fa-image" aria-hidden="true"></i>
      <span class="sr-only">No image available</span>
    </div>
    {% endif %}

    <!-- Project status badge -->
    <div class="project-status-badge">
      {% if project.is_funded %}
      <span class="badge bg-success">
        <i class="fas fa-check-circle" aria-hidden="true"></i>
        Funded
      </span>
      {% elif project.is_expired %}
      <span class="badge bg-danger">
        <i class="fas fa-clock" aria-hidden="true"></i>
        Expired
      </span>
      {% elif project.days_left <= 3 %}
      <span class="badge bg-warning">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
        {{ project.days_left }} day{{ project.days_left|pluralize }} left
      </span>
      {% else %}
      <span class="badge bg-info">
        <i class="fas fa-calendar" aria-hidden="true"></i>
        {{ project.days_left }} day{{ project.days_left|pluralize }} left
      </span>
      {% endif %}
    </div>

    <!-- Quick action buttons overlay -->
    <div class="project-actions-overlay">
      {% if user.is_authenticated %}
      <button
        class="btn btn-icon btn-favorite"
        data-project-id="{{ project.id }}"
        data-favorited="{{ project.is_favorited_by_user }}"
        aria-label="{% if project.is_favorited_by_user %}Remove from favorites{% else %}Add to favorites{% endif %}"
        title="{% if project.is_favorited_by_user %}Remove from favorites{% else %}Add to favorites{% endif %}"
      >
        <i
          class="{% if project.is_favorited_by_user %}fas{% else %}far{% endif %} fa-heart"
          aria-hidden="true"
        ></i>
      </button>
      {% endif %}

      <button
        class="btn btn-icon btn-share"
        data-url="{% url 'projects:detail' project.id %}"
        data-title="{{ project.title }}"
        aria-label="Share project"
        title="Share project"
      >
        <i class="fas fa-share-alt" aria-hidden="true"></i>
      </button>
    </div>
  </div>

  <div class="card-body">
    <!-- Project category -->
    <div class="project-category mb-2">
      <span class="badge bg-secondary">
        <i class="fas fa-tag" aria-hidden="true"></i>
        {{ project.get_category_display }}
      </span>
    </div>

    <!-- Project title and description -->
    <h5 class="card-title">
      <a href="{% url 'projects:detail' project.id %}" class="stretched-link">
        {{ project.title|truncatechars:60 }}
      </a>
    </h5>

    <p class="card-text text-muted">
      {{ project.description|truncatechars:120 }}
    </p>

    <!-- Creator info -->
    <div class="project-creator mb-3">
      <div class="d-flex align-items-center">
        {% if project.creator.profile_image %}
        <img
          src="{{ project.creator.profile_image.url }}"
          alt="{{ project.creator.get_full_name }}"
          class="creator-avatar"
        />
        {% else %}
        <div class="creator-avatar creator-avatar-placeholder">
          <i class="fas fa-user" aria-hidden="true"></i>
        </div>
        {% endif %}

        <div class="creator-info">
          <small class="text-muted">by</small>
          <span class="creator-name"
            >{{ project.creator.get_full_name|default:project.creator.username
            }}</span
          >
          {% if project.creator.is_verified %}
          <i
            class="fas fa-check-circle text-primary"
            aria-label="Verified creator"
            title="Verified creator"
          ></i>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Funding progress -->
    <div class="funding-progress mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="funding-amount">
          <strong class="current-amount"
            >{{ project.current_amount|floatformat:0 }}</strong
          >
          <small class="text-muted">EGP</small>
        </span>
        <span class="funding-percentage">
          {{ project.funding_percentage|floatformat:0 }}%
        </span>
      </div>

      <div
        class="progress"
        role="progressbar"
        aria-valuenow="{{ project.funding_percentage }}"
        aria-valuemin="0"
        aria-valuemax="100"
        aria-label="Funding progress: {{ project.funding_percentage|floatformat:0 }}%"
      >
        <div
          class="progress-bar"
          style="width: {{ project.funding_percentage }}%"
          data-progress="{{ project.funding_percentage }}"
        ></div>
      </div>

      <div class="funding-stats mt-2">
        <div class="row text-center">
          <div class="col-4">
            <div class="stat-item">
              <div class="stat-value">
                {{ project.goal_amount|floatformat:0 }}
              </div>
              <div class="stat-label">Goal (EGP)</div>
            </div>
          </div>
          <div class="col-4">
            <div class="stat-item">
              <div class="stat-value contributors-count">
                {{ project.contributors_count }}
              </div>
              <div class="stat-label">
                Backer{{ project.contributors_count|pluralize }}
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="stat-item">
              <div class="stat-value">{{ project.days_left }}</div>
              <div class="stat-label">
                Day{{ project.days_left|pluralize }} left
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card footer with actions -->
  <div class="card-footer bg-transparent">
    <div class="d-flex justify-content-between align-items-center">
      <!-- View project button -->
      <a
        href="{% url 'projects:detail' project.id %}"
        class="btn btn-outline-primary btn-sm"
      >
        <i class="fas fa-eye" aria-hidden="true"></i>
        View Details
      </a>

      <!-- Contribute button -->
      {% if not project.is_expired and not project.is_funded %} {% if
      user.is_authenticated %}
      <a
        href="{% url 'projects:contribute' project.id %}"
        class="btn btn-primary btn-sm"
      >
        <i class="fas fa-heart" aria-hidden="true"></i>
        Back This
      </a>
      {% else %}
      <a
        href="{% url 'accounts:login' %}?next={% url 'projects:contribute' project.id %}"
        class="btn btn-primary btn-sm"
      >
        <i class="fas fa-heart" aria-hidden="true"></i>
        Back This
      </a>
      {% endif %} {% elif project.is_funded %}
      <span class="badge bg-success">
        <i class="fas fa-trophy" aria-hidden="true"></i>
        Successfully Funded
      </span>
      {% else %}
      <span class="badge bg-secondary">
        <i class="fas fa-clock" aria-hidden="true"></i>
        Campaign Ended
      </span>
      {% endif %}
    </div>

    <!-- Project tags (if any) -->
    {% if project.tags.all %}
    <div class="project-tags mt-2">
      {% for tag in project.tags.all|slice:":3" %}
      <span class="badge bg-light text-dark me-1"> #{{ tag.name }} </span>
      {% endfor %} {% if project.tags.count > 3 %}
      <span class="text-muted">+{{ project.tags.count|add:"-3" }} more</span>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<style>
  /* Project Card Styles */
  .project-card {
    height: 100%;
    transition: var(--transition);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    position: relative;
  }

  .project-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .card-img-container {
    position: relative;
    height: 200px;
    overflow: hidden;
  }

  .card-img-top {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: var(--transition);
  }

  .project-card:hover .card-img-top {
    transform: scale(1.05);
  }

  .card-img-placeholder {
    width: 100%;
    height: 100%;
    background-color: var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-500);
    font-size: 3rem;
  }

  .project-status-badge {
    position: absolute;
    top: var(--spacing-md);
    left: var(--spacing-md);
    z-index: 2;
  }

  .project-actions-overlay {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    opacity: 0;
    transition: var(--transition);
  }

  .project-card:hover .project-actions-overlay {
    opacity: 1;
  }

  .btn-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.9);
    color: var(--gray-700);
    border: none;
    backdrop-filter: blur(10px);
    transition: var(--transition);
  }

  .btn-icon:hover {
    background-color: var(--primary-color);
    color: var(--white);
    transform: scale(1.1);
  }

  .btn-favorite.favorited {
    background-color: var(--danger-color);
    color: var(--white);
  }

  .project-creator {
    border-top: 1px solid var(--gray-200);
    border-bottom: 1px solid var(--gray-200);
    padding: var(--spacing-md) 0;
  }

  .creator-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: var(--spacing-md);
  }

  .creator-avatar-placeholder {
    background-color: var(--gray-300);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-600);
  }

  .creator-info {
    flex: 1;
  }

  .creator-name {
    font-weight: 600;
    color: var(--gray-800);
    margin-left: var(--spacing-xs);
  }

  .funding-progress .progress {
    height: 8px;
    background-color: var(--gray-200);
    border-radius: 4px;
  }

  .funding-progress .progress-bar {
    background: linear-gradient(
      90deg,
      var(--primary-color),
      var(--success-color)
    );
    border-radius: 4px;
    transition: width 0.6s ease;
  }

  .funding-stats .stat-item {
    text-align: center;
  }

  .funding-stats .stat-value {
    font-weight: 700;
    color: var(--gray-800);
    font-size: var(--font-size-lg);
  }

  .funding-stats .stat-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .project-tags .badge {
    font-size: 0.75rem;
    font-weight: 400;
  }

  .stretched-link {
    color: inherit;
    text-decoration: none;
  }

  .stretched-link:hover {
    color: var(--primary-color);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .card-img-container {
      height: 160px;
    }

    .project-actions-overlay {
      opacity: 1;
      flex-direction: row;
      top: auto;
      bottom: var(--spacing-md);
      right: var(--spacing-md);
    }

    .btn-icon {
      width: 35px;
      height: 35px;
    }

    .funding-stats .stat-value {
      font-size: var(--font-size-base);
    }
  }

  /* Loading animation for progress bars */
  @keyframes loading-shimmer {
    0% {
      background-position: -468px 0;
    }
    100% {
      background-position: 468px 0;
    }
  }

  .project-card.loading .progress-bar {
    background: linear-gradient(
      90deg,
      var(--gray-300) 25%,
      var(--gray-200) 50%,
      var(--gray-300) 75%
    );
    background-size: 1000px 100%;
    animation: loading-shimmer 2s infinite;
  }

  /* Accessibility improvements */
  .project-card:focus-within {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
  }

  @media (prefers-reduced-motion: reduce) {
    .project-card,
    .card-img-top,
    .btn-icon {
      transition: none;
    }

    .project-card:hover {
      transform: none;
    }

    .project-card:hover .card-img-top {
      transform: none;
    }
  }
</style>
